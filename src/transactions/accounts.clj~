(ns transactions.accounts
  (:require [clojure.xml :as xml]
            [clojure.zip :as zip]
            [clojure.data.zip.xml :as zxml]))

(defn accounts-zip [uri] (zip/xml-zip (xml/parse uri)))

(defn load-accounts [uri]
  (zxml/xml-> (accounts-zip uri) :map (zxml/attr :account)))

(defn account-descriptions [account]
  (zxml/xml-> accounts-zip :map (zxml/attr= :account account) :from zxml/text))

(defn map-description-to-account [descs account]
  (apply merge (for [description descs] {description account})))

(defn account-map [uri]
  (apply merge
         (for [account (load-accounts uri)]
           (map-description-to-account (account-descriptions account) account))))
